{% extends 'main.html' %}
{% block content %}
    {% load tag_tools %}
    {% load static %}

<div class="row">
	<div class="col-md-12">
		        <div class="tile">
                <div class="alert alert-dismissible alert-success" role="alert">Statistics Summary&nbsp;&nbsp;&nbsp;
					<a class="alert-link" href="/lizhi/home/">&lt;&lt;返回任务列表</a>&nbsp;&nbsp;&nbsp;
					<span style="color:red;font-size:15px;" id="error_xml"></span></h3>
				</div>
				<div class="tile-body">
					<div class="form-group row">
						<div class="col-md-12">
							<table class="table" id="StatisticsData">
			                    <thead>
			                    <tr>
			                        <th>QueryFrom</th>
									<th>FetchFrom</th>
			                        <th>Lizhi</th>
			                        <th>VR</th>
			                        <th>Baike</th>
			                        <th>Official</th>
			                        <th>Other</th>
			                        <th>Error</th>
			                    </tr>
			                    </thead>
			                    <tbody id="reqBody">
									<tr class="get_data">
										<th rowspan="2" style="background-color: green;">SOGOU ({{sg_count}})</th>
										<td>Sogou</td>
										<td>{{qf_sg_ft_sg.Lizhi}}</td>
										<td>{{qf_sg_ft_sg.VR}}</td>
										<td>{{qf_sg_ft_sg.Baike}}</td>
										<td>{{qf_sg_ft_sg.Official}}</td>
										<td>{{qf_sg_ft_sg.Other}}</td>
										<td>{{qf_sg_ft_sg.Error}}</td>
									</tr>
									<tr class="get_data">
										<td>Baidu</td>
										<td>{{qf_sg_ft_bd.Lizhi}}</td>
										<td>{{qf_sg_ft_bd.VR}}</td>
										<td>{{qf_sg_ft_bd.Baike}}</td>
										<td>{{qf_sg_ft_bd.Official}}</td>
										<td>{{qf_sg_ft_bd.Other}}</td>
										<td>{{qf_sg_ft_bd.Error}}</td>
									</tr>
									<tr class="get_data">
										<th rowspan="2" style="background-color: green;">BAIDU ({{bd_count}})</th>
										<td>Sogou</td>
										<td>{{qf_bd_ft_sg.Lizhi}}</td>
										<td>{{qf_bd_ft_sg.VR}}</td>
										<td>{{qf_bd_ft_sg.Baike}}</td>
										<td>{{qf_bd_ft_sg.Official}}</td>
										<td>{{qf_bd_ft_sg.Other}}</td>
										<td>{{qf_bd_ft_sg.Error}}</td>
									</tr>
									<tr class="get_data">
										<td>Baidu</td>
										<td>{{qf_bd_ft_bd.Lizhi}}</td>
										<td>{{qf_bd_ft_bd.VR}}</td>
										<td>{{qf_bd_ft_bd.Baike}}</td>
										<td>{{qf_bd_ft_bd.Official}}</td>
										<td>{{qf_bd_ft_bd.Other}}</td>
										<td>{{qf_bd_ft_bd.Error}}</td>
									</tr>

			                    </tbody>
			                </table>
						</div>
					</div>
				</div>
                <div class="alert alert-dismissible alert-success" role="alert">Cost Detail</div>
                <div class="tile-body">
					<div class="form-group row">
						<div class="col-md-12">
							<table class="table">
			                    <thead>
			                    <tr>
			                        <td style="width: 50%;">Test</td>
			                        <td style="width: 50%;">Base</td>
			                    </tr>
			                    </thead>
			                    <tbody id="reqBody">
			                    <tr req_id="">
			                        <td style="width: 50%;"><pre style="white-space: pre-wrap;word-wrap: break-word;">Get ret num:        	20953.600364523078</pre></td>
			                        <td style="width: 50%;"><pre style="white-space: pre-wrap;word-wrap: break-word;">Get ret num:        	17977.288152789977</pre></td>
			                    </tr>
			                    </tbody>
			               </table>
						</div>
					</div>
				</div>

				<div class="alert alert-dismissible alert-success" role="alert">Result Detail</div>
				  <div class="widget-small primary coloured-icon">
					<div class="info">
						<div class="form-group row" style="margin-bottom:0rem">
							<div class="col-md-2">
								<label class="control-label">搜索词来源</label>
								<select id="query_from" name="pstatus" class="form-control pfilter" style="cursor: pointer;">
									<option value="All"> 全部 </option>
									<option value="sogou"> 搜狗 </option>
									<option value="baidu"> 百度 </option>
								</select>
							</div>
							<div class="col-md-2">
								<label class="control-label">搜狗首条结果</label>
								<select id="sg_first_res" name="pfrom" class="form-control pfilter" style="cursor: pointer;">
									<option value="All"> 全部</option>
									<option value="Lizhi"> 立知</option>
									<option value="VR"> VR </option>
									<option value="Baike"> 百科 </option>
									<option value="Official"> 官网 </option>
									<option value="Other"> 其他 </option>
									<!--<option value="Error"> ERROR </option>-->
								</select>
							</div>
							<div class="col-md-2">
								<label class="control-label">百度首条结果</label>
								<select id="bd_first_res" name="httpcode" class="form-control pfilter" style="cursor: pointer;">
									<option value="All"> 全部</option>
									<option value="Lizhi"> 立知</option>
									<option value="Baike"> 百科 </option>
									<option value="Official"> 官网 </option>
									<option value="Other"> 其他 </option>
									<!--<option value="Error"> ERROR </option>-->
								</select>
							</div>

							<div class="col-md-2">
						    	<button class="btn btn-primary" type="button" id="submit"><i class="fa fa-fw fa-lg fa-check-circle"></i>Submit</button>
							</div>

						</div>
					</div>
				  </div>

				  <div class="tile-body">
							<div class="form-group row">
								<div class="col-md-12">
									<table class="table" id="selectedData">
										<thead>
										<tr>
											<th>QueryID</th>
											<th>Query</th>
											<th>QueryFrom</th>
											<th>sg_res_type</th>
											<th>sg_scene</th>
											<th>bd_res_type</th>
											<th>bd_scene</th>
											<th>Status</th>
										</tr>
										</thead>
										<tbody id="selectedDataBody">
											{% for item in all_res %}
										    <tr class="get_data">
										    	<td>{{item.query_id}}</td>
												<td style="word-wrap:break-word;word-break:break-all;" width="300px";>{{item.query}}</td>
												<td>{{item.query_from}}</td>
												<td>{{item.sg_res_type}}</td>
												<td>
													{% if item.sg_scene %}
														<a href={{item.sg_scene}} title="搜狗结果抓取现场" target="_blank">现场</a></td>
												    {% else %}
												   		<a title="该结果未保存现场">无现场</a> </td>
												    {% endif %}
											    </td>

											    <td>{{item.bd_res_type}}</td>
											    <td>
													{% if item.bd_scene %}
														<a href={{item.bd_scene}} title="百度结果抓取现场" target="_blank">现场</a></td>
											        {% else %}
														<a title="该结果未保存现场">无现场</a> </td>
													{% endif %}
											    </td>
												<td>{{item.status}}</td>
											</tr>
										    {% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						</div>
        </div>

        <div class="clearfix"></div>
</div>

{% endblock %}
{% block js %}
    <script>
        //判断ajax里面的方法是get还是post
        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        //只要执行一次ajaxSetup进行header设置,就可以不用在没个ajax里面添加header信息了
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader('X-CSRFtoken', $.cookie('csrftoken'))
                }
            }
        });

        //request
        $('#add_automation').click(function () {
            var qo_base_svn = $('#qo_basesvn').val()
            var qo_text_svn = $('#qo_testsvn').val()
            if (qo_base_svn != "" || qo_text_svn != "") {
                $.ajax({
                    type: "POST",
                    url: "/lizhi/auto/add",
                    async: true,
                    traditional: true,
                    data: $('#form_automation').serialize(),
                    dataType: 'JSON',
                    success: function (obj) {
                        console.log(obj.status)
                        if (obj.status) {
                            {#                            console.log(JSON.stringify($('#form_qo_addtask').serialize()))#}
                            location.reload();
                        } else {
                            $('#error_xml').text(obj.error);
                        }
                    },
                    error: function () {

                    },
                });
                $('#error_xml').text('');
            } else {
                $('#error_xml').text('svn不可都为空');
            }
        })

        //table hover
        $(function () {
            function showBox(obj, box) {
                var timer = null;
                $(obj).on("mouseover", function (e) {
                    clearTimeout(timer);
                    var clientX = e.clientX;
                    var clientY = e.clientY;
                    var y = clientY + 20;
                    var txt = $(this).text();
                    timer = setTimeout(function () {
                        $(box).css("left", clientX).css("top", y);
                        if (txt == "") {
                            $(box).hide();
                        } else {
                            $(box).show();
                            $(box).html(txt);
                        }
                    }, 300);
                });
                $(obj).on("mouseout", function () {
                    clearTimeout(timer);
                    $(box).hide();
                });
            }

            showBox("#reqData > tbody td", "#showDiv");
        });

        //del
        $('.del_line').click(function () {
            var line_id = $(this).parent().parent().attr('req_id');
            $.ajax({
                type: "POST",
                url: "del_xml_line",
                async: true,
                data: {
                    'line_id': line_id
                },
                dataType: 'JSON',
                success: function (obj) {
                    if (obj.status) {
                        location.reload();
                    } else {
                        $('#error_xml').text(obj.error);
                    }
                },
                error: function () {

                }
            });

        })

        //getData
        $('#get_data').dblclick(function () {
            var linelst = $(this).children();
            press_expid = $(linelst[3]).text();
            press_rate = $(linelst[4]).text();
            testtag = $(linelst[5]).text();
            testsvn = $(linelst[9]).text();
            basesvn = $(linelst[10]).text();
            newconfip = $(linelst[11]).text();
            newconfuser = $(linelst[12]).text();
            newconfpassw = $(linelst[13]).text();
            newconfpath = $(linelst[14]).text();
            newdataip = $(linelst[15]).text();
            newdatauser = $(linelst[16]).text();
            newdatapassw = $(linelst[17]).text();
            newdatapath = $(linelst[18]).text();
            press_qps = $(linelst[19]).text();
            press_time = $(linelst[20]).text();
            query_ip = $(linelst[21]).text();
            query_user = $(linelst[22]).text();
            query_pwd = $(linelst[23]).text();
            query_path = $(linelst[24]).text();

            $('#qo_testsvn').val(testsvn);
            $('#qo_basesvn').val(basesvn);
            $('#new_conf_ip').val(newconfip);
            $('#new_conf_user').val(newconfuser);
            $('#new_conf_pass').val(newconfpassw);
            $('#new_conf_path').val(newconfpath);
            $('#new_data_ip').val(newdataip);
            $('#new_data_user').val(newdatauser);
            $('#new_data_pass').val(newdatapassw);
            $('#new_data_path').val(newdatapath);
            $('#qo_qps').val(press_qps);
            $('#qo_press_time').val(press_time);
            $('#qo_press_rate').val(press_rate);
            $('#qo_press_expid').val(press_expid);
            $('#testtag').val(testtag);
            $('#query_ip').val(query_ip);
            $('#query_user').val(query_user);
            $('#query_pwd').val(query_pwd);
            $('#query_path').val(query_path);

        })


        $(document).ready(function () {
            $('#query_ip').attr('readonly', true);
            $('#query_user').attr('readonly', true);
            $('#query_pwd').attr('readonly', true);
            $('#query_path').attr('readonly', true);

            $('input[type=radio][name=radio_select]').change(function () {
                if (this.value == 'press') {
                    $('#query_ip').attr('readonly', true);
                    $('#query_user').attr('readonly', true);
                    $('#query_pwd').attr('readonly', true);
                    $('#query_path').attr('readonly', true);

                    $('#qo_qps').attr('readonly', false);
                    $('#qo_press_time').attr('readonly', false);
                }
                else if (this.value == 'longdiff') {
                    $('#qo_qps').attr('readonly', true);
                    $('#qo_press_time').attr('readonly', true);

                    $('#query_ip').attr('readonly', false);
                    $('#query_user').attr('readonly', false);
                    $('#query_pwd').attr('readonly', false);
                    $('#query_path').attr('readonly', false);
                }
            });

        });


        //query post请求方式
        $('#submit').click(function () {
            var query_from = $('#query_from').val()
            var sg_first_res = $('#sg_first_res').val()
            var bd_first_res = $('#bd_first_res').val()
            var curr_taskid = (window.location.pathname.split('_')[2].split('.')[0]);   //从当前url中获取task_id

            if (query_from != "" && sg_first_res != "" && bd_first_res != "") {
                $.ajax({
                    type: "POST",
                    url: "/lizhi/result/filter",
                    async: true,
                    traditional: true,
                    data: {
                        'query_from': query_from,
                        'sg_first_res': sg_first_res,
                        'bd_first_res': bd_first_res,
                        'task_id': curr_taskid,
                    },
                    dataType: 'JSON',
                    success: function (ret) {
                        if (ret.status) {
                            console.log(ret)
                            $("#selectedData tr:not(:first)").empty("");   //清空上一次查询的内容，保留表头
                            $("#selectedDataBody").html("")  //清空上一次无结果提示
                            var res = ret.data

                            if (res.length == 0){
                            $("#selectedDataBody").html("没有查到相应结果")
                            }else{
								var s = "";
								//拼接为表格
								for(var i=0; i<res.length; i++){
									s =  "<tr><td>" + res[i].pk + '</td><td style="word-wrap:break-word;word-break:break-all;" width="300px">' + res[i].fields.query + "</td><td>"
									     + res[i].fields.query_from + "</td><td>" + res[i].fields.sg_res_type + "</td><td>"

									     if (res[i].fields.sg_scene){
									     	s += '<a href=' + res[i].fields.sg_scene + ' title="搜狗结果抓取现场" target="_blank">现场</a></td><td>'
									     }
									     else{
									     	s += '<a title="该结果未保存现场">无现场</a> </td><td>'
									     }

										 s += res[i].fields.bd_res_type + "</td><td>"
										 if (res[i].fields.bd_scene){
									     	s += '<a href=' + res[i].fields.bd_scene + ' title="百度结果抓取现场" target="_blank">现场</a></td><td>'
									     }
									     else{
									     	s += '<a title="该结果未保存现场">无现场</a> </td><td>'
									     }

										 s += res[i].fields.status + "</td></tr>"
									$("#selectedData").append(s)
								}
							}

                        } else {
                            $('#error_xml').text(ret.error)
                        }
                    },
                    error: function () {
                    },
                });
                $('#error_xml').text('');
            }

        })


        <!--//query-->
        <!--$('#submit').click(function () {-->
        	<!--var query_from = $('#query_from').val()-->
        	<!--var sg_first_res = $('#sg_first_res').val()-->
        	<!--var bd_first_res = $('#bd_first_res').val()-->
        	<!--var curr_taskid = (window.location.pathname.split('_')[2].split('.')[0]);   //从当前url中获取task_id-->
            <!--$(this).get("lizhi/result",-->
                        <!--{-->
                        	<!--queryfrom: query_from,-->
                        	<!--sg: sg_first_res,-->
                        	<!--bd: bd_first_res,-->
                        	<!--task_id: curr_taskid-->
                        <!--},-->
                        <!--function (ret) {-->
                        <!--console.log(ret)-->
                        <!--})-->

        <!--})-->



        //diff
        $('#start_diff').click(function () {
            var query = $('#query').val()

            var inputHost = $('#inputHost').val()
            var forceQuery = $('#forceQuery').val()
            var query_from = $('#query_from').val()

            var inputHost_diff = $('#inputHost_diff').val()
            var forceQuery_diff = $('#forceQuery_diff').val()
            var query_from_diff = $('#query_from_diff').val()
			$('#res').addClass('hide');
			$('#diff').removeClass('hide');
			$('#result').text('');
			$('#result_diff').html("")
            $('#jzwd_result').html("")
            $('#rec_result').html("")
            $('#int_result').html("")
            if (query != "" && inputHost != "" && inputHost_diff != "") {
                $.ajax({
                    type: "POST",
                    url: "/tupush/debug/diff",
                    async: true,
                    traditional: true,
                    data: {
                        'inputHost': inputHost,
                        'forceQuery': forceQuery,
                        'query_from': query_from,
                        'query': query,
                        'inputHost_diff': inputHost_diff,
                        'forceQuery_diff': forceQuery_diff,
                        'query_from_diff': query_from_diff
                    },
                    dataType: 'JSON',
                    success: function (ret) {
                        if (ret.status) {
//                          $('#result').hide()
                            $('#result_diff').html(ret.data.total_data)
                            $('#jzwd_result').html(ret.data.jzwd_data)
                            $('#rec_result').html(ret.data.rec_data)
                            $('#int_result').html(ret.data.int_data)
                        } else {
                            $('#error_xml').text(ret.error)
                        }
                    },
                    error: function () {
                    },
                });
                $('#error_xml').text('');
            } else {
                if (query == '') {
                    $('#error_xml').text('Request不可为空');
                } else if (inputHost == '') {
                    $('#error_xml').text('Host不可为空');
                } else {
                    $('#error_xml').text('未知错误');
                }
            }
        })



    </script>
{% endblock %}


